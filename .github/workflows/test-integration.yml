name: test-integration
on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
    build:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: /var/www/html/
        timeout-minutes: 30
        container:
          image: ghcr.io/openconext/openconext-basecontainers/php82-apache2-node20-composer2:latest
          volumes:
            - .:/var/www/html
        steps:
          - name: Checkout
            uses: actions/checkout@v6

          - name: Get Composer cache directory
            id: composer-cache
            run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

          - name: Cache Composer dependencies
            uses: actions/cache@v4
            with:
              path: ${{ steps.composer-cache.outputs.dir }}
              key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
              restore-keys: |
                ${{ runner.os }}-composer-

          - name: Composer install
            run: composer install

          - name: Run QA tests
            run: composer check-ci
            env:
              SYMFONY_DEPRECATIONS_HELPER: 999999

          - name: Output logs on failure
            if: failure()
            run: |
              cd ci/docker
              docker compose logs